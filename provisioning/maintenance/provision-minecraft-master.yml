---
- hosts: minecraftgameserver
  vars_files:
    - vars/pluginlist.yml
    - vars/whitelist_players.yml
    - ./../vars/facts_mc_node.yml
  become: true
  tasks:
    - include_role:
        name: geerlingguy.java
      vars:
        java_packages:
          - java-11-openjdk

    - include_role:
        name: install_rcon

    - name: configure the mc server
      include_role:
        name: nolte.minecraft
      vars:
        minecraft_version: "{{ mc_version }}"
        minecraft_server: spigot
        minecraft_eula_accept: "true"
        minecraft_plugins_set_version: "{{ pluginset }}"
        minecraft_plugin_sets: "{{ mc_plugin_sets }}"
        minecraft_max_memory: 1024M
        minecraft_initial_memory: 1024M
        minecraft_ops:
          - nolte07
          - _BlueBeaver_
          - m4yl0n
        minecraft_whitelist: "{{ whitelist_users }}"
        minecraft_server_properties:
          server-port: 25565
          rcon.port: 25564
          enable-rcon: true
          rcon.password: "{{ lookup('password', '/tmp/passwordfile chars=ascii_letters,digits,hexdigits,punctuation') }}"
          white-list: true
          enable-command-block: true
          motd: "Amazing Minecraft Server"
          online-mode: true
          resource-pack: http://backup.just-mfg.de/Gerudoku_Faithful_3D_Models_Add-on.zip

    - name: open the gameport for external usage
      firewalld:
        port: 25565/tcp
        permanent: true
        state: enabled
      notify: restart firewalld
    - name: close the rcon for external usage
      firewalld:
        port: 25564/tcp
        permanent: true
        state: disabled
      notify: restart firewalld

    - name: open the dynmapport for external usage
      firewalld:
        port: 8123/tcp
        permanent: true
        state: enabled
      notify: restart firewalld

  handlers:
    - name: restart sshd
      service:
        name: sshd
        state: restarted

    - name: restart firewalld
      service:
        name: firewalld
        state: restarted
#
